---
import Base from "../layouts/Base.astro";
import { SITE } from "../config/site";

/* ========= Query / Pagination ========= */
const reqUrl = new URL(Astro.request.url);
const pageSize = Math.min(50, Math.max(3, Number(reqUrl.searchParams.get("pageSize") ?? 9)));
const page = Math.max(1, Number(reqUrl.searchParams.get("page") ?? 1));
const offset = (page - 1) * pageSize;

/* ========= Data holders ========= */
let reviews: any[] = [];
let totalCount = 0;
let placeMeta: { rating?: number; user_ratings_total?: number; name?: string } = {};

/* ========= Helpers ========= */
async function fetchJSON(u: URL) {
  try {
    const r = await fetch(u.toString());
    if (!r.ok) return null;
    return await r.json();
  } catch {
    return null;
  }
}

/* ========= Fetch flow ========= */
try {
  // 1) Try v1 "all reviews"
  const v1Url = new URL("/api/all-reviews.json", Astro.url);
  // (These params are ignored by the v1 endpoint, but harmless if present)
  v1Url.searchParams.set("limit", String(pageSize));
  v1Url.searchParams.set("offset", String(offset));
  const v1 = await fetchJSON(v1Url);

  // 2) Legacy endpoint for meta and as fallback
  const legacyUrl = new URL("/api/reviews.json", Astro.url);
  const legacy = await fetchJSON(legacyUrl);

  // Prefer v1 reviews if present; otherwise use legacy (~5)
  const chosen = (v1 && Array.isArray(v1.reviews) && v1.reviews.length > 0) ? v1 : (legacy ?? { reviews: [] });

  const all = Array.isArray(chosen.reviews) ? chosen.reviews : [];
  totalCount = Number(chosen?._count ?? all.length);

  // Use v1/legacy reviews, but always try to show meta from legacy (it contains rating & totals)
  if (legacy) {
    placeMeta = {
      name: legacy?.name,
      rating: legacy?.rating,
      user_ratings_total: legacy?.user_ratings_total,
    };
  }

  // Slice for current page
  reviews = all.slice(offset, offset + pageSize);
} catch {
  reviews = [];
  totalCount = 0;
}

/* ========= Pagination math ========= */
const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));

function pageHref(p: number) {
  const u = new URL(Astro.url);
  u.searchParams.set("page", String(p));
  u.searchParams.set("pageSize", String(pageSize));
  return u.pathname + u.search;
}

// Build compact numbered list with gaps (e.g. 1 … 4 5 6 … 12)
type PageItem = number | 'gap';
function buildPageItems(curr: number, total: number): PageItem[] {
  const items: number[] = [];
  const add = (n: number) => { if (!items.includes(n)) items.push(n); };
  add(1);
  add(total);
  for (let n = curr - 1; n <= curr + 1; n++) {
    if (n >= 1 && n <= total) add(n);
  }
  items.sort((a, b) => a - b);

  const withGaps: PageItem[] = [];
  for (let i = 0; i < items.length; i++) {
    const currItem = items[i];
    if (i > 0) {
      const prevItem = items[i - 1];
      if (currItem - prevItem > 1) withGaps.push('gap');
    }
    withGaps.push(currItem);
  }
  return withGaps;
}
const pageItems = buildPageItems(page, totalPages);

const PAGE = {
  title: "Client Reviews | DaVinci Radiance Teeth Whitening",
  description: "Read real 4★+ client reviews for DaVinci Radiance in Lone Tree & Colorado Springs.",
};
---

<Base title={PAGE.title} description={PAGE.description}>
  <section class="mx-auto max-w-6xl pt-12 pb-20 px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-10">
      <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">What Our Clients Say</h1>
      {placeMeta?.rating && placeMeta?.user_ratings_total && (
        <p class="mt-2 text-slate-600">
          Google rating <span class="font-semibold">{placeMeta.rating}</span>/5 · {placeMeta.user_ratings_total} reviews
        </p>
      )}
      {placeMeta?.name && <p class="mt-1 text-sm text-slate-500">{placeMeta.name}</p>}
    </div>

    {totalCount === 0 ? (
      <div class="mx-auto max-w-md text-center rounded-xl border border-slate-200 bg-white p-8 shadow-sm text-slate-600">
        <p>No reviews available yet. Check back soon!</p>
      </div>
    ) : (
      <>
        <!-- Grid -->
        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
          {reviews.map((rv) => (
            <article class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm transition hover:shadow-md">
              <div class="flex items-center gap-3">
                {rv.profile_photo_url ? (
                  <img
                    src={rv.profile_photo_url}
                    alt={rv.author_name}
                    width="40"
                    height="40"
                    class="h-10 w-10 rounded-full"
                    loading="lazy"
                    decoding="async"
                  />
                ) : (
                  <div class="h-10 w-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 font-medium">
                    {rv.author_name?.[0] ?? "?"}
                  </div>
                )}
                <div>
                  <div class="font-semibold text-slate-900">{rv.author_name}</div>
                  <div class="text-sm text-slate-500">{rv.time_desc}</div>
                </div>
              </div>
              <div class="mt-3 text-amber-500 text-sm" aria-label={`${rv.rating} out of 5 stars`}>
                {"★".repeat(rv.rating)}{"☆".repeat(5 - rv.rating)}
              </div>
              <p class="mt-3 text-slate-700 whitespace-pre-wrap leading-relaxed">{rv.text}</p>
            </article>
          ))}
        </div>

        <!-- Pagination -->
        {totalPages > 1 && (
          <nav class="mt-10 flex items-center justify-center gap-2" aria-label="Pagination">
            <a
              href={page > 1 ? pageHref(page - 1) : undefined}
              aria-disabled={page <= 1}
              class={`px-3 py-2 rounded-md border text-sm ${
                page > 1 ? "border-slate-300 text-slate-700 hover:bg-slate-50" : "border-slate-200 text-slate-400 pointer-events-none"
              }`}
            >
              Prev
            </a>

            {pageItems.map((it) =>
              it === 'gap' ? (
                <span class="px-1 text-slate-400">…</span>
              ) : (
                <a
                  href={pageHref(it as number)}
                  aria-current={it === page ? "page" : undefined}
                  class={`px-3 py-2 rounded-md border text-sm ${
                    it === page
                      ? "border-emerald-600 bg-emerald-50 text-emerald-700"
                      : "border-slate-300 text-slate-700 hover:bg-slate-50"
                  }`}
                >
                  {it}
                </a>
              )
            )}

            <a
              href={page < totalPages ? pageHref(page + 1) : undefined}
              aria-disabled={page >= totalPages}
              class={`px-3 py-2 rounded-md border text-sm ${
                page < totalPages ? "border-slate-300 text-slate-700 hover:bg-slate-50" : "border-slate-200 text-slate-400 pointer-events-none"
              }`}
            >
              Next
            </a>
          </nav>
        )}
      </>
    )}

    <!-- CTA -->
    <div class="mt-16 text-center">
      <p class="text-lg text-slate-700 mb-4">Ready to love your smile? Call or text to schedule today.</p>
      <div class="flex flex-wrap justify-center gap-3">
        <a href={`tel:${SITE.phone}`} class="rounded-lg bg-emerald-600 px-5 py-3 font-semibold text-white hover:bg-emerald-700">
          Call {SITE.phoneHuman}
        </a>
        <a href={`sms:${SITE.sms}`} class="rounded-lg border border-emerald-600 px-5 py-3 font-semibold text-emerald-700 hover:bg-emerald-50">
          Text to Schedule
        </a>
      </div>
    </div>
  </section>
</Base>
